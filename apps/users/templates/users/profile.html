{% extends 'base.html' %} {% load static %} 

{% block title %}
    Perfil
{% endblock %}



{% block css %}
    <style>
        .input-group-text{display:none;}
        #id_image{position:absolute;top:-9999px;left:-9999px;}
        .form-control.d-flex.h-auto{position:absolute;top:-9999px;left:-9999px;}
    </style>
{% endblock %}



{% block content %} 

    {% load crispy_forms_tags %}
    
    <div class="d-flex flex-column" id="content-wrapper">
        <div id="content">
            <div class="container-fluid">
                
                <h3 class="text_type_color mb-4">
                    Perfil
                </h3>
                
                <div class="card shadow mb-3">
                    <div class="card-header py-3">
                        <p class="text_type_color m-0 fw-bold">
                            Opciones de usuario
                        </p>
                    </div>

                    <div class="card-body">
                        <!-- Start: Form -->
                        <form method="post" enctype="multipart/form-data">
                            {% csrf_token %}

                            <div class="row" style="margin-bottom: 25px;text-align: left;">
                                <div class="col-sm-4 col-md-4 col-lg-3 col-xl-2 col-xxl-2" style="display: inline;text-align: center;margin-bottom: 25px;">

                                    <!-- Image Display -->
                                    {% if form.image.value != '' %}
                                        <img id="img-preview" class="mb-3 mt-4 img-fluid" src="/media/{{form.image.value}}" style="display: inline;max-height: 110px; clip-path: circle(55px at 50% 50%);" draggable="false">
                                        <p id="noImageText" style="display:none"><br><br>Imagen Removida</p>
                                    {% else %}
                                        <img id="img-preview" class="mb-3 mt-4 img-fluid" src="/media/{{form.image.value}}" style="display: none;max-height: 110px; clip-path: circle(55px at 50% 50%);" draggable="false">
                                        <p id="noImageText"><br><br>Sin Imagen<br></p>
                                    {% endif %}

                                    <!-- We are hiding this image inputs with a position absolute style that
                                    renders them outside the screen -->
                                    {{form.image|as_crispy_field}}<br>
                                                                            
                                    <button id="photoBtn" class="btn btn-sm mt-1" type="button" style="background-color: #691C32; color: white;">
                                        Cambiar {% if form.image.value == '' %}Foto{% endif %}
                                    </button>
                                    
                                    {% if form.image.value != '' %}
                                        <!-- The clear button will only render when we have a Profile Image -->
                                        <button id="clearImage" class="btn btn-sm mt-1" type="button" style="background-color: #10312B; color: white;">
                                            Limpiar
                                        </button>
                                    {% endif %}
                                </div>

                                <div class="col-sm-8 col-md-8 col-lg-9 col-xl-10 col-xxl-10 align-self-center">
                                    <div class="row">
                                        <div class="col-xl-12 col-lg-12 text-start">
                                            {{form.email|as_crispy_field}}
                                        </div>

                                        <div class="col-xl-6 col-lg-12 text-start">
                                            <div class="mb-3">
                                                {{form.password|as_crispy_field}}
                                            </div>
                                        </div>

                                        <div class="col-xl-6 col-lg-12 text-start">
                                            <div class="mb-3">
                                                {{form.password2|as_crispy_field}}
                                            </div>
                                        </div>
                                    </div>
                                </div>

                            

                                <!-- Start: Error Messages -->
                                <div class="col" id="errorMessagesDiv">
                                    <p id="emailErrorMsg" class="text-danger" style="display:none;"></p>
                                    <p id="passwordErrorMsg" class="text-danger" style="display:none;"></p>
                                </div>
                                
                                <div class="col-md-12" style="text-align: right;margin-top: 5px;">
                                    <button class="btn btn-sm" id="submitBtn" type="submit" style="background-color: #691C32; color: white;">
                                        Guardar Cambios
                                    </button>
                                </div>
                            </div>
                        </form>
                        <!-- End: Form -->
                    </div>
                </div>
            </div>
        </div>
    </div>
{% endblock %}



{% block js %}
    <script>
        let email = document.getElementById("email")
        let password = document.getElementById("password")
        let verifyPassword = document.getElementById("verifyPassword")
        let submitBtn = document.getElementById("submitBtn")
        let emailErrorMsg = document.getElementById('emailErrorMsg')
        let passwordErrorMsg = document.getElementById('passwordErrorMsg')

        let imagePreview = document.getElementById('img-preview')
        let originalImage = imagePreview.src
        let originalImageSplitCount = originalImage.split("/").length
        let imageInput = document.getElementById('id_image')
        let noImageText = document.getElementById("noImageText")
        let clearImageButton = document.getElementById("clearImage")
        let clearImageCheckBox = document.getElementById("image-clear_id")
        let divIdImage = document.getElementById("div_id_image");
        divIdImage.style.position = "absolute";

        let imageErrorMsg = $('#error_1_id_image')
        if(imageErrorMsg) {
            imageErrorMsg.appendTo("#errorMessagesDiv");
            imageErrorMsg.addClass("text-danger").removeClass("invalid-feedback");
        }

        // FUNCTIONS 

        function displayErrorMsg(type, msg) {
            if(type == "email") {
                emailErrorMsg.style.display = "block"
                emailErrorMsg.innerHTML = msg
                submitBtn.disabled = true
            }
            else {
                passwordErrorMsg.style.display = "block"
                passwordErrorMsg.innerHTML = msg
                submitBtn.disabled = true
            }
        }

        function hideErrorMsg(type) {
            if(type == "email") {
                emailErrorMsg.style.display = "none"
                emailErrorMsg.innerHTML = ""
                submitBtn.disabled = true
                if(passwordErrorMsg.innerHTML == "")
                    submitBtn.disabled = false
            }
            else {
                passwordErrorMsg.style.display = "none"
                passwordErrorMsg.innerHTML = ""
                if(emailErrorMsg.innerHTML == "")
                    submitBtn.disabled = false
            }
        }
        
        // Validate password upon change
        password.addEventListener("input", function() {

            // If password has no value, then it won't be changed and no error will be displayed
            if(password.value.length == 0 && verifyPassword.value.length == 0) hideErrorMsg("password")
            
            // If password has a value, then it will be checked. In this case the passwords don't match
            else if(password.value !== verifyPassword.value) displayErrorMsg("password", "Las contrase単as no coinciden")
            
            // When the passwords match, we check the length
            else {
                // Check if the password has 8 characters or more
                if(password.value.length >= 8)
                    hideErrorMsg("password")
                else
                    displayErrorMsg("password", "La contrase単a debe tener al menos 8 caracteres")
            }
        })
        verifyPassword.addEventListener("input", function() {
            if(password.value !== verifyPassword.value)
                displayErrorMsg("password", "Las contrase単as no coinciden")
            else {
                // Check if the password has 8 characters or more
                if(password.value.length >= 8)
                    hideErrorMsg("password")
                else
                    displayErrorMsg("password", "La contrase単a debe tener al menos 8 caracteres")
            }
        })

        // Open Image Selection Upon Button Click
        document.getElementById("photoBtn").addEventListener("click", function() {
            $("#id_image").click();
        });

        // Clear Image Script
        if(clearImageButton) {
            clearImageButton.addEventListener("click", function() {
                clearImageCheckBox.checked = true;
                clearImageButton.disabled = true
                noImageText.style.display = "block"
                imagePreview.style.display = "none"
                imageInput.value = ""
            });
        }
        
        // Render Image Upon Change (Jquery) Script
        imageInput.addEventListener("change", function() {
            if(this.files && this.files[0]) {
                var reader = new FileReader();
                reader.onload = function(e) {

                    noImageText.style.display = "none"
                    imagePreview.style.display = "inline";
                    $('#img-preview').attr('src', e.target.result);
                }

                reader.readAsDataURL(this.files[0]);
                imageErrorMsg.hide();
                
                if(clearImageCheckBox) {
                    clearImageCheckBox.checked = false;
                    clearImageButton.disabled = false
                }
            }
            else {
                imagePreview.style.display = "none"
                noImageText.style.display = "block"
                
                if(clearImageCheckBox) {
                    clearImageCheckBox.checked = true;
                    clearImageButton.disabled = true
                }
            }
        });
    </script>
{% endblock %}